#!/usr/bin/env bash
# vim: set ft=sh

docker_required() {
    echo ""
    echo "É necessário permissão de super usuário"
    sudo true

    # docker
    if [[ `which docker` == '' ]]; then
        echo "Docker não está instalado."
        exit 0
    fi

    # docker-compose
    if [[ `which docker-compose` == '' ]]; then
        echo "Docker-compose não está instalado, ou ele não está na pasta /usr/bin."
        exit 0
    fi

    # compilando a maquina
    echo ""
    echo "Será iniciado o build da maquina do portal."
    echo "Tenha paciência, isso irá demorar um pouco. :)"
    echo "Vai lá e pega um café, a espera será mais feliz."
    echo ""
}

docker_start() {
    # start
    docker_required

    # Baixando as imagens
    docker-compose pull

    #iniciando as imagens
    docker_up_containers

    # Configurando o ambiente
    docker_base
}

docker_build () {
    # start
    docker_required

    # remove todos os containers
    docker-compose down

    # baixa todas as imagens necessários

    # download image mysql
    # docker pull mysql:5.7

    # executa o build
    sudo docker-compose build

    #configurando o banco de dados
    docker-compose up -d
    sleep 10

    # configurando o anbiente
    docker_base

    # faz as últimas configurações
    docker_up_containers_reset_db
}

docker_base() {
    #Configurações do docker
    docker exec sympla_db sh -c "mysql -uroot -psympla123 -e \"set global sql_mode='STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';\""
    docker exec sympla_db sh -c "mysql -uroot -psympla123 -e \"set session sql_mode='STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION';\""
    docker exec sympla_db sh -c "mysql -uroot -psympla123 -e \"DROP DATABASE SYMPLADB; CREATE DATABASE SYMPLADB;\""
    docker exec sympla_db sh -c "mysql -uroot -psympla123 -e \"GRANT ALL PRIVILEGES ON *.* TO 'sympla'@'%' IDENTIFIED BY 'sympla123' WITH GRANT OPTION;\""
    docker exec sympla_db sh -c "mysql -uroot -psympla123 -e \"GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY 'sympla123' WITH GRANT OPTION;\""
    docker exec sympla_db sh -c "mysql -uroot -psympla123 -e \"FLUSH PRIVILEGES;\""

    docker cp resources/portal/my.cnf sympla_db:/etc/mysql/conf.d/mysql.cnf

    # Permissão de escrita
    sudo chmod 777 -R frontend/protected/runtime frontend/assets

    declare -i count
    count=`cat /etc/hosts | grep "172.0.0.2 revamp.sympla.com.br" | wc -l`

    if [ $count -eq 0 ]; then
        echo "172.0.0.2 revamp.sympla.com.br" | sudo tee -a /etc/hosts
    fi
}


docker_up_containers() {
    docker-compose start
}

docker_down_containers() {
    docker-compose stop
}

docker_up_containers_with_logs() {
    docker_up_containers
    docker-compose logs --tail=50 -f
}

docker_up_containers_reset_db() {
    #flag
    chmod 777 resources/reset_db
    echo "1" > resources/reset_db

    docker_down_containers
    docker_up_containers

    #up
    docker_up_containers_with_logs
}

git_hooks_setup() {
    chmod +x resources/scripts/git-hooks/*
    cd .git/hooks
    cp -fs ../../resources/scripts/git-hooks/* .
    cd -
}

echo "Seja bem-vindo ao menu de setup."
echo "Por favor escolha uma das opções abaixo:"

echo "1 - Deploy com o Docker"
echo "2 - Iniciar os containers"
echo "3 - Iniciar os containers com logs"
echo "4 - Iniciar os containers e resetar o banco de dados"
echo "5 - Desligar os containers"

if [ "$1" == "" ]; then
    echo -n "Digite sua opção: "
    read -n 1 option
    echo ""
else
    option="$1"
fi
if [ "$option" == "1" ]; then
    docker_build
elif [ "$option" == "2" ]; then
    docker_up_containers
elif [ "$option" == "3" ]; then
    docker_up_containers_with_logs
elif [ "$option" == "4" ]; then
    docker_up_containers_reset_db
elif [ "$option" == "5" ]; then
    docker_down_containers
else
    echo ""
    echo ":) Você quase acertou. Agora tente uma opção entre 1 e 5"
fi
